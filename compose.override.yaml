# Development environment override
services:
  php:
    build:
      context: ./api
      target: frankenphp_dev
    volumes:
      - ./api:/app
      - /app/var
      - ./api/frankenphp/Caddyfile:/etc/frankenphp/Caddyfile:ro
      - ./api/frankenphp/conf.d/20-app.dev.ini:/usr/local/etc/php/app.conf.d/20-app.dev.ini:ro
      # If you develop on Mac or Windows you can remove the vendor/ directory
      #  from the bind-mount for better performance by enabling the next line:
      #- /app/vendor
    environment:
      FRANKENPHP_WORKER_CONFIG: watch
      # See https://xdebug.org/docs/all_settings#mode
      XDEBUG_MODE: "${XDEBUG_MODE:-off}"
    extra_hosts:
      # Ensure that host.docker.internal is correctly defined on Linux
      - host.docker.internal:host-gateway
    tty: true

###> doctrine/doctrine-bundle ###
  database:
    ports:
      - target: 5432
        published: 5432
        protocol: tcp
###< doctrine/doctrine-bundle ###

  mkdocs:
    build:
      dockerfile: docker/mkdocs-material/Dockerfile
      context: ./
    profiles: [ "docs" ]
    depends_on:
      phpdoc:
        condition: service_completed_successfully
      phpmetrics:
        condition: service_completed_successfully
    volumes:
      - ./:/docs
    healthcheck:
      test: [ "CMD-SHELL", "curl --fail http://localhost:8000 || exit 1" ]
      start_period: 15s
      interval: 5s
      timeout: 3s
      retries: 15
    tty: true
    stdin_open: true
    ports:
      - "8000:8000"

  phpdoc:
    image: phpdoc/phpdoc
    pull_policy: always
    profiles: [ "docs" ]
    entrypoint: /data/docker/phpdoc/entrypoint.sh
    volumes:
      - ./:/data

  phpmetrics:
    image: esoledad/php:8.5
    pull_policy: always
    profiles: [ "docs" ]
    working_dir: /shared/httpd/ae-api
    command: vendor/bin/phpmetrics --config=phpmetrics.json --report-html=docs/phpmetrics
    volumes:
      - ./:/shared/httpd/ae-api
